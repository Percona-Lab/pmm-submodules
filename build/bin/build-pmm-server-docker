#!/bin/bash

set -o errexit
set -o xtrace

root_dir=$(cd $(dirname $0)/../..; pwd -P)
rpms_dir=${root_dir}/build/pmm-server-docker/RPMS

docker run -it --rm -v ${rpms_dir}:/home/builder/rpm/RPMS perconalab/rpmbuild sh -c "
    /usr/bin/createrepo_c --update /home/builder/rpm/RPMS
"
tag=$(git rev-parse --abbrev-ref HEAD)
if [ -z "${tag}" ] || [[ ${tag} == "master" ]]; then
    tag=$(date -u '+%Y%m%d%H%M')
fi
docker build --squash --no-cache -t perconalab/pmm-server:${tag} ${root_dir}/build/pmm-server-docker
