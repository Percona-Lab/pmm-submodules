#!/bin/bash

set -o errexit
set -o xtrace

root_dir=$(cd $(dirname $0)/../..; pwd -P)
rpms_dir=${root_dir}/build/pmm-server-docker/RPMS
rpmbuild_dir=${root_dir}/sources/pmm-server-packaging/rhel
pmm_version=$(cat ${root_dir}/VERSION)

get_rpm_version() {
    local spec_name=$1

    local rpm_version=$(
        egrep '%global\s+commit\s+' ${rpmbuild_dir}/SPECS/${spec_name}.spec \
            | awk '{print substr($3, 0, 7)}'
    )
    if [ -z "${rpm_version}" ]; then
        local rpm_version=$(
            egrep "Version:|Release:" ${rpmbuild_dir}/SPECS/${spec_name}.spec \
                | cut -d: -f 2 \
                | cut -d% -f 1 \
                | tr -d ' ' \
                | paste -sd '-' -
        )
    fi

    # return version
    echo ${rpm_version}
}

is_build_needed() {
    local spec_name=$1
    local rpm_version=$2

    aws s3 sync \
        --region us-east-2 \
        --no-sign-request \
        s3://pmm-build-cache/${spec_name}-${rpm_version} \
        ${rpms_dir}/${spec_name}-${rpm_version}

    local packages=$(find ${rpms_dir}/${spec_name}-${rpm_version} -name "*.rpm" | wc -l)

    # return result as true or flase
    [[ ${packages// /} == 0 ]]
}

prepare_specs() {
    local spec_name=$1
    local repo_name=$2

    if [ -d "${root_dir}/sources/${repo_name}" ]; then
        local git_dir=$(dirname $(find "${root_dir}/sources/${repo_name}" -name .git | head -1))
        local full_commit=$(git -C "${git_dir}" rev-parse HEAD)
        local short_commit=${full_commit:0:7}

        sed -i -e "s/global commit.*/global commit ${full_commit}/" ${rpmbuild_dir}/SPECS/${spec_name}.spec
        sed -i -e "s/Version:.*/Version: ${pmm_version}/"           ${rpmbuild_dir}/SPECS/${spec_name}.spec

        if [ -f "${rpmbuild_dir}/SOURCES/${repo_name}-${short_commit}.tar.gz" ]; then
            echo SOURCES/${repo_name}-${short_commit}.tar.gz already exists, skipping build
        else
            git -C "${git_dir}" archive \
                --format=tar.gz \
                --prefix=${repo_name}-${full_commit}/ \
                -o ${rpmbuild_dir}/SOURCES/${repo_name}-${short_commit}.tar.gz \
                "${full_commit}"
        fi
    fi
}

build() {
    local spec_name=$1
    local repo_name=${2:-$1}

    prepare_specs "${spec_name}" "${repo_name}"
    local rpm_version=$(get_rpm_version "${spec_name}")
    if is_build_needed "${spec_name}" "${rpm_version}" || [[ -n "${FORCE_REBUILD}" ]]; then
        docker run -it --rm -v ${rpmbuild_dir}:/home/builder/rpm -v ${rpms_dir}:/home/builder/rpm/RPMS perconalab/rpmbuild sh -c "
            set -o errexit
            set -o xtrace

            printf '[local]\nname=local\nbaseurl=file:///home/builder/rpm/RPMS\ngpgcheck=0\nenabled=1\n' \
                | sudo tee /etc/yum.repos.d/local.repo
            /usr/bin/createrepo_c --update /home/builder/rpm/RPMS
            ls -la /home/builder/rpm/RPMS
            sudo yum-builddep -y SPECS/${spec_name}.spec

            spectool -C SOURCES -g SPECS/${spec_name}.spec
            rpmbuild --define '_rpmdir %{_topdir}/RPMS/${spec_name}-${rpm_version}' -ba SPECS/${spec_name}.spec
        "

        aws s3 sync \
            --region us-east-2 \
            ${rpms_dir}/${spec_name}-${rpm_version} \
            s3://pmm-build-cache/${spec_name}-${rpm_version} \
            || :
    fi
}

build "$1" "$2"
echo DONE
