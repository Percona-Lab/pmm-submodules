---
- hosts: all
  become: yes
  gather_facts: yes

  tasks:
    - debug:
        var: ansible_version

    - name: Check Ansible version
      assert:
        that: "ansible_version.full is version('2.8', '>=')"
        fail_msg: Unexpected Ansible version

    - name: cloud-init                 | Create dirs
      file: path={{ item }} state=directory owner=pmm group=pmm
      with_items:
        - /srv/prometheus/data
        - /srv/prometheus/rules
        - /srv/collect_info
        - /srv/logs

    - name: PMM                        | Create dirs
      file: path={{ item }} state=directory owner=root group=pmm
      with_items:
        - /srv/clickhouse

    - name: NGINX                      | Disable daemon
      lineinfile:
        dest: /etc/nginx/nginx.conf
        line: 'daemon off;'

    - name: PMM                        | Fix nginx config
      replace:
        dest: /etc/nginx/nginx.conf
        regexp: '^(\s*)listen'
        replace: '\1#listen'

    - name: PMM                        | Fix nginx config
      replace:
        dest: /etc/nginx/nginx.conf
        regexp: '/var/log/nginx/error\.log'
        replace: '/srv/logs/nginx.error.log'

    - name: PMM                        | Fix nginx config
      replace:
        dest: /etc/nginx/nginx.conf
        regexp: '/var/log/nginx/access\.log'
        replace: '/srv/logs/nginx.access.log'

    - name: PMM                        | Fix postgresql config
      replace:
        dest: /srv/postgres/postgresql.conf
        regexp: 'log_directory = (.)log'
        replace: 'log_directory = \1../log'

    - name: PMM                        | Fix postgresql config
      replace:
        dest: /srv/postgres/postgresql.conf
        regexp: 'log_filename = ''postgresql-%a'
        replace: 'log_filename = ''postgresql'

    - name: Grafana                    | Enable gzip
      ini_file:
        dest: /etc/grafana/grafana.ini
        section: server
        option: enable_gzip
        value: true

    - name: PMM                        | Start services
      shell: supervisord -c /etc/supervisord.conf &

    - name: PMM                        | Wait for postgres start
      wait_for:
        port: 5432
        state: present
        delay: 30
        timeout: 60

    - name: pmm-managed                | Create PostgreSQL database
      postgresql_db:
        name: pmm-managed
        state: present

    - name: pmm-managed                | Create PostgreSQL user
      postgresql_user:
        db: pmm-managed
        name: pmm-managed
        password: 'md5da757ec3e22c6d86a2bb8e70307fa937'
        priv: 'ALL'
        expires: infinity
        state: present

    - name: pmm-managed                | Create pg_stat_statements PostgreSQL extension
      postgresql_ext:
        db: pmm-managed
        name: pg_stat_statements

    - name: PMM                        | Wait for dashboards
      wait_for:
        path: /srv/grafana/PERCONA_DASHBOARDS_VERSION
        state: present

    - name: Grafana                    | Add community panels
      unarchive:
        src: "{{ item }}"
        dest: /var/lib/grafana/plugins
        remote_src: yes
      with_fileglob:
        - "/usr/share/percona-dashboards/panels/*.zip"

    - name: PMM                        | Create ClickHouse database
      command: clickhouse-client --query="CREATE DATABASE IF NOT EXISTS pmm"

    - name: PMM                        | Show ClickHouse database
      command: clickhouse-client --query="SHOW DATABASES"

    - name: PMM                        | Create pmm-update dirs
      file: path={{ item }} state=directory
      with_items:
        - /srv/update

    - name: PMM                        | Check pmm-update
      stat: path=/srv/update/main.yml
      register: pmm_update_file

    - name: PMM                        | Enable testing repo for pmm-client and percona-toolkit
      when: not pmm_update_file.stat.exists
      command: yum-config-manager --enable percona-testing-x86_64 --enable pmm2-laboratory

    - name: PMM                        | Run pmm-update
      when: not pmm_update_file.stat.exists
      command: env EXTRA_ARGS='--extra-vars image_creation=1' /usr/bin/pmm-update-stage2

    - name: PMM                        | Enable testing repo for pmm-client and percona-toolkit
      when: not pmm_update_file.stat.exists
      command: yum-config-manager --disable percona-testing-x86_64 --disable pmm-laboratory

    - name: pmm-agent                  | Setup
      command: >
        pmm-agent setup
        --config-file=/usr/local/percona/pmm-agent.yaml
        --skip-registration
        --id=pmm-server
        --server-address=127.0.0.1:443
        --server-insecure-tls

    - name: PMM                        | Stop services
      shell: supervisorctl shutdown

    - name: PMM                        | Cleanup yum cache
      shell: yum clean all

    - name: PMM                        | Cleanup logs
      file: path={{ item }} state=absent
      with_items:
        - /srv/logs/clickhouse-server.err.log
        - /srv/logs/clickhouse-server.log
        - /srv/logs/clickhouse-server.startup.log
        - /srv/logs/cron.log
        - /srv/logs/dashboard-upgrade.log
        - /srv/logs/grafana.log
        - /srv/logs/nginx.startup.log
        - /srv/logs/pmm-agent.log
        # - /srv/logs/pmm-configurator.log
        # - /srv/logs/pmm-manage.log
        - /srv/logs/pmm-managed.log
        - /srv/logs/postgres.log
        - /srv/logs/postgres.startup.log
        - /srv/logs/prometheus.log
        - /srv/logs/qan-api2.log
        - /var/log/yum.log
        - /var/log/grafana/grafana.log
        - /var/log/supervisor/supervisord.log

    - name: PMM                        | Cleanup data
      file: path={{ item }} state=absent
      with_items:
        - /srv/prometheus/data
        - /srv/prometheus/rules
        - /tmp/RPMS

    - name: cloud-init                 | Create dirs
      file: path={{ item }} state=directory owner=pmm group=pmm
      with_items:
        - /srv/prometheus/data
        - /srv/prometheus/rules
        - /srv/logs
