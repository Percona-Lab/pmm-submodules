on: 
  workflow_dispatch:
    inputs:
      server_image:
        description: 'server image: repo/name:tag'     
        required: true
        type: string 
      client_image:
        description: 'client image: repo/name:tag'
        required: true 
        type: string

jobs:

  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: percona-platform/checkout@v3
        with:
          submodules: 'recursive'
      - uses: percona-platform/setup-node@v3
        with:
          node-version: '14'
      - run: npm install -g bats

  minikube_start:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - run: |
          ./sources/pmm-qa/src/github.com/percona/pmm-qa/pmm-tests/install_k8s_tools.sh --minikube
          minikube start

  helm_tests:
    needs: minikube_start
    runs-on: ubuntu-latest
    steps:
      - run: |
          cd ./sources/pmm-qa/src/github.com/percona/pmm-qa/pmm-tests/
          
          ./install_k8s_tools.sh --helm --kubectl
          
          export IMAGE_REPO=$(echo $SERVER_IMAGE | cut -d ':' -f 1)
          export IMAGE_TAG=$(echo $SERVER_IMAGE | cut -d ':' -f 2)
          bats --tap pmm-2-0-bats-tests/helm-test.bats
        env:
          SERVER_IMAGE: ${{ inputs.server_image }}
